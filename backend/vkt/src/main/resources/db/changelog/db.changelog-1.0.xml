<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<databaseChangeLog logicalFilePath="migrations.xml"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="2022-09-14-create-table-exam_language" author="mikhuttu">
        <createTable tableName="exam_language">
            <column name="name" type="VARCHAR(10)">
                <constraints primaryKey="true" primaryKeyName="exam_language_pkey"/>
            </column>
        </createTable>

        <insert tableName="exam_language">
            <column name="name" value="FI"/>
        </insert>
        <insert tableName="exam_language">
            <column name="name" value="SV"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-14-create-table-exam_level" author="mikhuttu">
        <createTable tableName="exam_level">
            <column name="name" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="exam_level_pkey"/>
            </column>
        </createTable>

        <insert tableName="exam_level">
            <column name="name" value="EXCELLENT"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-14-create-table-exam_event" author="mikhuttu">
        <createTable tableName="exam_event">
            <column autoIncrement="true" name="exam_event_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="exam_event_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="language" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="level" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="registration_closes" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="is_visible" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="max_participants" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="exam_event" baseColumnNames="language"
                                 referencedTableName="exam_language" referencedColumnNames="name"
                                 constraintName="fk_exam_event_language"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="exam_event" baseColumnNames="level"
                                 referencedTableName="exam_level" referencedColumnNames="name"
                                 constraintName="fk_exam_event_level"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addUniqueConstraint tableName="exam_event"
                             columnNames="language, level, date"
                             constraintName="uk_exam_event_language_level_date"/>

        <sql><![CDATA[
            ALTER TABLE exam_event ADD CONSTRAINT ck_exam_event_registration_closes CHECK (registration_closes <= date)
        ]]></sql>
        <sql><![CDATA[
            ALTER TABLE exam_event ADD CONSTRAINT ck_exam_event_max_participants CHECK (max_participants >= 0)
        ]]></sql>
    </changeSet>
</databaseChangeLog>

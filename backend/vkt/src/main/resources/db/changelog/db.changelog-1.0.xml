<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<databaseChangeLog logicalFilePath="migrations.xml"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="2022-09-14-create-table-exam_language" author="mikhuttu">
        <createTable tableName="exam_language">
            <column name="name" type="VARCHAR(10)">
                <constraints primaryKey="true" primaryKeyName="exam_language_pkey"/>
            </column>
        </createTable>

        <insert tableName="exam_language">
            <column name="name" value="FI"/>
        </insert>
        <insert tableName="exam_language">
            <column name="name" value="SV"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-14-create-table-exam_level" author="mikhuttu">
        <createTable tableName="exam_level">
            <column name="name" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="exam_level_pkey"/>
            </column>
        </createTable>

        <insert tableName="exam_level">
            <column name="name" value="EXCELLENT"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-14-create-table-exam_event" author="mikhuttu">
        <createTable tableName="exam_event">
            <column autoIncrement="true" name="exam_event_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="exam_event_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="language" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="level" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="registration_closes" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="is_visible" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="max_participants" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="exam_event" baseColumnNames="language"
                                 referencedTableName="exam_language" referencedColumnNames="name"
                                 constraintName="fk_exam_event_language"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="exam_event" baseColumnNames="level"
                                 referencedTableName="exam_level" referencedColumnNames="name"
                                 constraintName="fk_exam_event_level"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addUniqueConstraint tableName="exam_event"
                             columnNames="language, level, date"
                             constraintName="uk_exam_event_language_level_date"/>

        <sql><![CDATA[
            ALTER TABLE exam_event ADD CONSTRAINT ck_exam_event_registration_closes CHECK (registration_closes <= date)
        ]]></sql>
        <sql><![CDATA[
            ALTER TABLE exam_event ADD CONSTRAINT ck_exam_event_max_participants CHECK (max_participants >= 0)
        ]]></sql>
    </changeSet>

    <changeSet id="2022-09-19-create-table-person" author="mikhuttu">
        <createTable tableName="person">
            <column autoIncrement="true" name="person_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="person_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="onr_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint tableName="person" columnNames="onr_id" constraintName="uk_person_onr_id"/>
    </changeSet>

    <changeSet id="2022-09-19-create-table-enrollment_status" author="mikhuttu">
        <createTable tableName="enrollment_status">
            <column name="name" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="enrollment_status_pkey"/>
            </column>
        </createTable>

        <insert tableName="enrollment_status">
            <column name="name" value="PAID"/>
        </insert>
        <insert tableName="enrollment_status">
            <column name="name" value="EXPECTING_PAYMENT"/>
        </insert>
        <insert tableName="enrollment_status">
            <column name="name" value="QUEUED"/>
        </insert>
        <insert tableName="enrollment_status">
            <column name="name" value="CANCELED"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-19-create-table-enrollment" author="mikhuttu">
        <createTable tableName="enrollment">
            <column autoIncrement="true" name="enrollment_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="enrollment_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="exam_event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="person_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="skill_oral" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="skill_textual" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="skill_understanding" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="partial_exam_speaking" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="partial_exam_speech_comprehension" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="partial_exam_writing" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="partial_exam_reading_comprehension" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="previous_enrollment_date" type="DATE"/>
            <column name="digital_certificate_consent" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="enrollment" baseColumnNames="exam_event_id"
                                 referencedTableName="exam_event" referencedColumnNames="exam_event_id"
                                 constraintName="fk_enrollment_exam_event"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="enrollment" baseColumnNames="person_id"
                                 referencedTableName="person" referencedColumnNames="person_id"
                                 constraintName="fk_enrollment_person"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="enrollment" baseColumnNames="status"
                                 referencedTableName="enrollment_status" referencedColumnNames="name"
                                 constraintName="fk_enrollment_status"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addUniqueConstraint tableName="enrollment"
                             columnNames="exam_event_id, person_id"
                             constraintName="uk_enrollment_exam_event_person"/>
    </changeSet>

    <changeSet id="2022-10-12-change-person-columns" author="mikhuttu">
        <dropColumn tableName="person">
            <column name="onr_id"/>
        </dropColumn>

        <addColumn tableName="person">
            <column name="identity_number" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="street" type="TEXT"/>
            <column name="postal_code" type="TEXT"/>
            <column name="town" type="TEXT"/>
            <column name="country" type="TEXT"/>
        </addColumn>

        <addUniqueConstraint tableName="person" columnNames="identity_number" constraintName="uk_person_identity_number"/>
    </changeSet>

    <changeSet id="2022-10-28-create-table-reservation" author="terova">
        <createTable tableName="reservation">
            <column autoIncrement="true" name="reservation_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="reservation_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="exam_event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="person_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="reservation" baseColumnNames="exam_event_id"
                                 referencedTableName="exam_event" referencedColumnNames="exam_event_id"
                                 constraintName="fk_reservation_exam_event"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="reservation" baseColumnNames="person_id"
                                 referencedTableName="person" referencedColumnNames="person_id"
                                 constraintName="fk_reservation_person"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addUniqueConstraint tableName="reservation"
                             columnNames="exam_event_id, person_id"
                             constraintName="uk_reservation_exam_event_person"/>
    </changeSet>

    <changeSet id="2022-11-17-move_columns_from_person_to_enrollment" author="terova">
        <addColumn tableName="enrollment">
            <column name="email" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="street" type="TEXT"/>
            <column name="postal_code" type="TEXT"/>
            <column name="town" type="TEXT"/>
            <column name="country" type="TEXT"/>
        </addColumn>
        <dropColumn tableName="person">
            <column name="email"/>
            <column name="phone_number"/>
            <column name="street"/>
            <column name="postal_code"/>
            <column name="town"/>
            <column name="country"/>
        </dropColumn>
    </changeSet>


</databaseChangeLog>

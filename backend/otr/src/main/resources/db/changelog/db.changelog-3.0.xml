<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<databaseChangeLog logicalFilePath="migrations.xml"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="2022-09-22-create-table-interpreter" author="mikhuttu">
        <createTable tableName="interpreter">
            <column autoIncrement="true" name="interpreter_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="interpreter_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="onr_id" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_interpreter_onr_id"/>
            </column>
            <column name="permission_to_publish_email" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="permission_to_publish_phone" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="other_contact_information" type="TEXT"/>
            <column name="permission_to_publish_other_contact_information" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="extra_information" type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="2022-09-22-create-region-table" author="mikhuttu">
        <createTable tableName="region">
            <column autoIncrement="true" name="region_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="region_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="interpreter_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint tableName="region"
                             columnNames="interpreter_id, code"
                             constraintName="uk_region_interpreter_code"/>

        <addForeignKeyConstraint baseTableName="region" baseColumnNames="interpreter_id"
                                 referencedTableName="interpreter" referencedColumnNames="interpreter_id"
                                 constraintName="fk_region_interpreter"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>

    <changeSet id="2022-09-22-create-meeting_date-table" author="mikhuttu">
        <createTable tableName="meeting_date">
            <column autoIncrement="true" name="meeting_date_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="meeting_date_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="date" type="DATE">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_meeting_date_date"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2022-09-22-create-table-qualification_examination_type" author="mikhuttu">
        <createTable tableName="qualification_examination_type">
            <column name="name" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="qualification_examination_type_pkey"/>
            </column>
        </createTable>

        <insert tableName="qualification_examination_type">
            <column name="name" value="LEGAL_INTERPRETER_EXAM"/>
        </insert>
        <insert tableName="qualification_examination_type">
            <column name="name" value="OTHER"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-22-create-table-qualification" author="mikhuttu">
        <createTable tableName="qualification">
            <column autoIncrement="true" name="qualification_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="qualification_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="interpreter_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="meeting_date_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="from_lang" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="to_lang" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="examination_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="begin_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="permission_to_publish" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="diary_number" type="VARCHAR(255)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="qualification" baseColumnNames="interpreter_id"
                                 referencedTableName="interpreter" referencedColumnNames="interpreter_id"
                                 constraintName="fk_qualification_interpreter"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="qualification" baseColumnNames="meeting_date_id"
                                 referencedTableName="meeting_date" referencedColumnNames="meeting_date_id"
                                 constraintName="fk_qualification_meeting_date"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="qualification" baseColumnNames="examination_type"
                                 referencedTableName="qualification_examination_type" referencedColumnNames="name"
                                 constraintName="fk_qualification_examination_type"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <!-- For each row in old production database `kielipari` table, `kielesta` is `FI` and `kieleen` is the other language  -->
        <sql><![CDATA[
            ALTER TABLE qualification
                ADD CONSTRAINT ck_qualification_from_lang CHECK (from_lang = 'FI')
            ]]>
        </sql>

        <sql><![CDATA[
            ALTER TABLE qualification
                ADD CONSTRAINT ck_qualification_from_lang_to_lang CHECK (from_lang <> to_lang)
            ]]>
        </sql>

        <!-- This constraint didn't exist in `kielipari` table in old production datababase but holds for that data -->
        <sql><![CDATA[
            ALTER TABLE qualification
                ADD CONSTRAINT ck_qualification_begin_date_end_date CHECK (begin_date < end_date)
            ]]>
        </sql>
    </changeSet>

    <changeSet id="2022-09-22-create-email_type-table" author="mikhuttu">
        <createTable tableName="email_type">
            <column name="name" type="VARCHAR(255)">
                <constraints primaryKey="true" primaryKeyName="email_type_pkey"/>
            </column>
        </createTable>

        <insert tableName="email_type">
            <column name="name" value="QUALIFICATION_EXPIRY"/>
        </insert>
    </changeSet>

    <changeSet id="2022-09-22-create-email-table" author="mikhuttu">
        <createTable tableName="email">
            <column autoIncrement="true" name="email_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="email_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="email_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="recipient_name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="recipient_address" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="subject" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="body" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="sent_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="ext_id" type="TEXT"/>
            <column name="error" type="TEXT"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="email" baseColumnNames="email_type"
                                 referencedTableName="email_type" referencedColumnNames="name"
                                 constraintName="fk_email_email_type"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>

    <changeSet id="2022-09-22-create-qualification_reminder-table" author="mikhuttu">
        <createTable tableName="qualification_reminder">
            <column autoIncrement="true" name="qualification_reminder_id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="qualification_reminder_pkey"/>
            </column>
            <column name="version" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="TEXT"/>
            <column name="modified_by" type="TEXT"/>
            <column name="deleted_by" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="modified_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="qualification_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="email_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="qualification_reminder" baseColumnNames="qualification_id"
                                 referencedTableName="qualification" referencedColumnNames="qualification_id"
                                 constraintName="fk_qualification_reminder_qualification"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="qualification_reminder" baseColumnNames="email_id"
                                 referencedTableName="email" referencedColumnNames="email_id"
                                 constraintName="fk_qualification_reminder_email"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>

    <changeSet id="2022-09-22-create-shedlock-table" author="mikhuttu">
        <createTable tableName="shedlock">
            <column name="name" type="VARCHAR(64)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="lock_until" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="locked_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="locked_by" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
